## mysql架构

客户端mysql：使用mysqlconn库可以在编程语言中使用sql

服务端mysqld：连接层，server层，存储引擎层

### 连接层：

负责客户端连接请求的监听与建立，还包括安全权限认证，连接管理和线程管理。

最大连接数由参数控制，当达到最大连接时，新的连接请求会被拒绝。

wait_timeout参数控制客户端连接自动断开的时间。

线程管理分为每个连接一个线程和线程池两种模式，由参数thread_handing控制，支持在线修改。线程池调度固定数量的线程处理客户端的请求，避免线程频繁创建，切换，销毁的开销。

### 服务层

#### 查询缓存(query_cache)

query_cache是一个内存的kv，key是执行过的sql，value是查询的结果。执行一个sql之前先在看是否命中查询缓存，是则返回，不是的话再执行完成后，查询结果会被缓存起来。

需要注意的是：query_cache失效非常平频繁，只要对一个表的更新就会导致该表上的所有query_cache失效

#### sql解析器(Parser)

parser负责对sql语句进行词法分析和语法分析。

词法分析：将sql中字符串识别为数据库中的结构

语法分析：检查该sql是否符合语法要求

#### 优化器(Optimizer)

optimizer负责生成执行计划，交给执行器执行。

在一个表有多个index的时候选择走哪个index；执行join时选择join的类型，如hash join还是merge join等；join的顺序；决定谓词的所在的位置等等。

#### 执行器

根据执行计划执行语句。首先需要判断该用户是否对查询的表有查询权限，没有返回权限问题，有则打开该表进行查询。

执行器一般调用存储引擎的接口直接拿到表的一行数据。

分为没有索引和走索引的查询

### 存储引擎层

#### Buffer poll

在内存中缓存表的数据页和索引页，加快访问速度。buffer_pool的innodb_buffer_size由参数控制，当放不下所有的数据页时需要使用淘汰算法(LRU等)替换一些页

#### Log Buffer

缓存事务的redo log，保证事务的持久性。在FORCE模式下需要在事务提交时将事务的log flush到磁盘上持久化。FORCE模式对应参数innodb_flush_log_at_trx_commit = 1

buffer大小受参数innodb_log_buffer_size控制

#### 自适应hash索引

加入索引的查询速度，innodb根据查询频率和模式建立hash索引，根据hash索引快速(O(1)时间)定位到数据位置，比查询b+树快。

### 物理文件

分为数据文件，索引文件，日志文件，临时文件

数据文件，索引文件和临时文件都是由一个or多个固定大小的页组成，页大小一般16KB

日志文件用于存储日志，由两个或多个固定大小的日志段组成，保证事务的持久性

临时文件一般是查询过程中产生的中间结果，eg：临时表，sort后的结果等

